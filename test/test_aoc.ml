open! Core
open! Hardcaml
open! Hardcaml_waveterm
open! Hardcaml_test_harness
module Aoc = Hardcaml_demo_project.Aoc
module Harness = Cyclesim_harness.Make (Aoc.I) (Aoc.O)

let ( <--. ) = Bits.( <--. )

let simple_testbench (sim : Harness.Sim.t) =
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let cycle ?n () = Cyclesim.cycle ?n sim in

  (* Reset the design *)
  inputs.reset := Bits.vdd;
  cycle ();
  inputs.reset := Bits.gnd;
  cycle ();

  inputs.puzzle := Bits.of_int_trunc ~width:5 0b100;
  cycle ();

  (* helper to feed input data *)
  let feed_data n = 
    while not (Bits.to_bool !(outputs.data_ready)) do
      cycle ()
    done;

    inputs.data.value <--. n;
    inputs.data.valid := Bits.vdd;
    cycle ();
    inputs.data.valid := Bits.gnd;
    cycle()
  in

  let compute x y =
    feed_data x;
    feed_data y;

    (* Wait for result to become valid *)
    while not (Bits.to_bool !(outputs.result.valid)) do
      cycle ()
    done;

    let answer = Bits.to_unsigned_int !(outputs.result.value) in
    print_s [%message "Result" (answer : int)];
  in

  compute 11 22;

  cycle ~n:4 ();
;;

(* The [waves_config] argument to [Harness.run] determines where and how to save waveforms
   for viewing later with a waveform viewer. The commented examples below show how to save
   a waveterm file or a VCD file. *)
let waves_config = Waves_config.no_waves

(* let waves_config = *)
(*   Waves_config.to_directory "/tmp/" *)
(*   |> Waves_config.as_wavefile_format ~format:Hardcamlwaveform *)
(* ;; *)

(* let waves_config = *)
(*   Waves_config.to_directory "/tmp/" *)
(*   |> Waves_config.as_wavefile_format ~format:Vcd *)
(* ;; *)

let%expect_test "Simple test, optionally saving waveforms to disk" =
  Harness.run_advanced ~waves_config ~create:Aoc.hierarchical simple_testbench;
  [%expect {| (Result (answer 33)) |}]
;;

let%expect_test "Simple test with printing waveforms directly" =
  (* For simple tests, we can print the waveforms directly in an expect-test (and use the
     command [dune promote] to update it after the tests run). This is useful for quickly
     visualizing or documenting a simple circuit, but limits the amount of data that can
     be shown. *)
  let display_rules =
    [ Display_rule.port_name_matches
        ~wave_format:(Bit_or Unsigned_int)
        (Re.Glob.glob "aoc*" |> Re.compile)
    ]
  in

  Harness.run_advanced
    ~create:Aoc.hierarchical
    ~trace:`All_named
    ~print_waves_after_test:(fun waves ->
      Waveform.print
        ~display_rules
          (* [display_rules] is optional, if not specified, it will print all named
             signals in the design. *)
        ~signals_width:26
        ~display_width:186
        ~wave_width:1
        (* [wave_width] configures how many chars wide each clock cycle is *)
        ~start_cycle:38
        waves;

      Waveform.print
        ~display_rules
        ~signals_width:26
        ~display_width:140
        ~wave_width:1
        ~start_cycle:76
        waves;
    )
    simple_testbench;
  [%expect
    {|
    (Result (answer 33))
    ┌Signals─────────────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │                        ││────┬───┬───┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$bits_processed  ││ 30 │31 │32 │33                                                                                                                                               │
    │                        ││────┴───┴───┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────┬───┬───┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$convert_buffer  ││ 32.│64.│42.│0                                                                                                                                                │
    │                        ││────┴───┴───┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                        ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │aoc$bcd$i$convert       ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$i$increment     ││                        ┌───┐               ┌───┐               ┌───┐               ┌───┐               ┌───┐               ┌───┐               ┌───┐         │
    │                        ││────────────────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └─────────│
    │aoc$bcd$i$reset         ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$i$start_value   ││ 11                                                                                                                                                           │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬─────│
    │aoc$bcd$o$int_value     ││ 11                             │12                 │13                 │14                 │15                 │16                 │17                 │18   │
    │                        ││────────────────────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴─────│
    │aoc$bcd$o$is_invalid    ││                    ┌───────────────────┐                                                                                                                     │
    │                        ││────────────────────┘                   └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$o$ready         ││                    ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐         │
    │                        ││────────────────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘       └─────────│
    │aoc$i$clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                        ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │aoc$i$data$valid        ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$data$value        ││ 22                                                                                                                                                           │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$puzzle            ││ 4                                                                                                                                                            │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$reset             ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$invalid_sum         ││ 0                      │11                                                                                                                                   │
    │                        ││────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$o$data_ready        ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬─────────│
    │aoc$o$debug             ││ 2                      │3  │2              │3  │2              │3  │2              │3  │2              │3  │2              │3  │2              │3  │2        │
    │                        ││────────────────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴─────────│
    │aoc$o$result$valid      ││                                                                                                                                                              │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$o$result$value      ││ 0                                                                                                                                                            │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$range               ││ 12                                                                                                                                                           │
    │                        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬─────────────│
    │aoc$range_counter       ││ 0                      │1                  │2                  │3                  │4                  │5                  │6                  │7            │
    │                        ││────────────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴─────────────│
    └────────────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    ┌Signals─────────────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$bits_processed  ││ 33                                                                                                                                 │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$convert_buffer  ││ 0                                                                                                                                  │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$i$clock         ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                        ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │aoc$bcd$i$convert       ││                                                                                                                                    │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$bcd$i$increment     ││            ┌───┐               ┌───┐               ┌───┐               ┌───┐               ┌───┐               ┌───┐               │
    │                        ││────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────┘   └───────────────│
    │aoc$bcd$i$reset         ││                                                                                                                                    │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────│
    │aoc$bcd$i$start_value   ││ 11                                                                                                                     │0          │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────│
    │                        ││────────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────│
    │aoc$bcd$o$int_value     ││ 18                 │19                 │20                 │21                 │22                 │23                 │24         │
    │                        ││────────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────│
    │aoc$bcd$o$is_invalid    ││                                                                                        ┌───────────────────┐                       │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────┘                   └───────────────────────│
    │aoc$bcd$o$ready         ││        ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───────┐           ┌───│
    │                        ││────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘       └───────────┘   │
    │aoc$i$clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                        ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │aoc$i$data$valid        ││                                                                                                                                    │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$data$value        ││ 22                                                                                                                                 │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$puzzle            ││ 4                                                                                                                                  │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$i$reset             ││                                                                                                                                    │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────│
    │aoc$invalid_sum         ││ 11                                                                                         │33                                     │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────│
    │aoc$o$data_ready        ││                                                                                                                            ┌───────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘       │
    │                        ││────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───┬───────────────┬───────────┬───────│
    │aoc$o$debug             ││ 2          │3  │2              │3  │2              │3  │2              │3  │2              │3  │2              │3          │0      │
    │                        ││────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───┴───────────────┴───────────┴───────│
    │aoc$o$result$valid      ││                                                                                                                    ┌───────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘               │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────│
    │aoc$o$result$value      ││ 0                                                                                                                  │33             │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────│
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │aoc$range               ││ 12                                                                                                                                 │
    │                        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                        ││────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────┬───────────│
    │aoc$range_counter       ││ 7          │8                  │9                  │10                 │11                 │12                 │13     │0          │
    │                        ││────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────┴───────────│
    └────────────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}]
;;
